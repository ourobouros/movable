
#include "frame_erythrocyte_editor.h"

#include <QtWidgets>

ErythrocyteEditor::ErythrocyteEditor(const QString &name, QWidget *parent)
    : QWidget(parent) {
}

BloodImage* ImageViewer::getImage() {
    return image;
}

QList<ParasiteItem*> *ImageViewer::getParasitViews() {
    return parasits;
}

void ImageViewer::loadScene(BloodImage* image)
{
    this->image = image;
    scene->clear();
//    scene = new QGraphicsScene;
//    view->setScene(scene);

    /* Background */
    QGraphicsPixmapItem *background = new QGraphicsPixmapItem(QPixmap::fromImage(*image->getImage()));
    scene->addItem(background);

    /* Drawing Area */
    drawing_area = new ImageItem(image);
    drawing_area->setPos(0,0);
    scene->addItem(drawing_area);
    drawing_area->setVisible(false);
    drawing_area->setActive(false);

    /* Erythrocytes */
    erythrocytes = new QList<ErythrocyteItem*>();

    foreach (Erythrocyte *e, *image->getErythrocytes())
    {
        ErythrocyteItem *item = new ErythrocyteItem(e);
        erythrocytes->push_back(item);
        item->setPos(e->getPos());
        scene->addItem(item);
    }

    /* Detected leukocytes */
//    foreach (ErythrocyteItem *e, *erythrocytes)
//    {
//        QList<QGraphicsItem *> list = scene->collidingItems(e);

//        if(list.size() > 6) {

//            foreach (QGraphicsItem *ery, list) {
//                if(ery->pos().rx() != 0 && ery->pos().ry() != 0)
//                    scene->removeItem(ery);
//            }
//        }
//    }

     /* Parasites */
    parasits = new QList<ParasiteItem*>();

    foreach (Parasit* p, *image->getParasits())
    {
        ParasiteItem *item = new ParasiteItem(p);
        parasits->push_back(item);
        item->setPos(p->getImageX(),p->getImageY());        
        scene->addItem(item);
    }

    parasit_selected = 0;

    QMatrix matrix;
    matrix.scale(zoom_value, zoom_value);
    view->setMatrix(matrix);
}

void ImageViewer::centerOn(int id)
{
    parasits->at(parasit_selected)->setSelected(false);

    parasit_selected = id;

    parasits->at(parasit_selected)->setSelected(true);

    qreal x = parasits->at(parasit_selected)->getParasit()->getX();
    qreal y = parasits->at(parasit_selected)->getParasit()->getY();

    view->centerOn(x,y);
}

void ImageViewer::zoomIn()
{
    zoom_value += 0.2;

    QMatrix matrix;
    matrix.scale(zoom_value, zoom_value);
    view->setMatrix(matrix);
}

void ImageViewer::zoomOut()
{
    zoom_value -= 0.2;

    QMatrix matrix;
    matrix.scale(zoom_value, zoom_value);
    view->setMatrix(matrix);
}


void ImageViewer::setPointerMode()
{
    if(pen_parasite_item->isChecked() || pen_undefined_item->isChecked() || eraser->isChecked()) {

        view->setDragMode(QGraphicsView::RubberBandDrag);
        view->setInteractive(true);

        // Drawing Mode
        drawing_area->setVisible(true);
        drawing_area->setActive(true);

        foreach (ErythrocyteItem* e, *erythrocytes)
            e->setVisible(false);

        foreach (ParasiteItem* p, *parasits)
            p->setVisible(false);

        drawing_area->setEraserPen(eraser->isChecked());
        drawing_area->setParasitePen(pen_parasite_item->isChecked());
    }
    else {
        // Edition Mode
        view->setDragMode(mouse->isChecked()
                                     ? QGraphicsView::RubberBandDrag
                                     : QGraphicsView::ScrollHandDrag);

        view->setInteractive(mouse->isChecked());

        drawing_area->setVisible(false);
        drawing_area->setActive(false);

        foreach (ErythrocyteItem* e, *erythrocytes)
            e->setVisible(mouse_erythrocytes->isChecked());

        foreach (ParasiteItem* p, *parasits)
            p->setVisible(mouse_parasites->isChecked());
    }
}

void ImageViewer::setBigPen() {

}

void ImageViewer::setSmallPen() {

}

